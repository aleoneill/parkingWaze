<!DOCTYPE html>
<html>
<head>
    <title>Parking Waze</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
</head>
<body>
    <div class="backButton">
        <a id="backButton" href="/">
            <p>Back</p>
        </a>
    </div>
    <div class="header1">
        <h1>Parking Waze</h1>
    </div>
    
    <h2>Time of Arrival on Campus?</h2>
    <form id="arrival">
        <input type="text" class="timepicker" name="time" id="timeOfArrival" />
    </form>
    <br><br>
    <h2>Location of Next Class:</h2>
    <div class="buildings">
        <div class="select">
            <select id="buildingChoice">
                <option value="">Select One</option>
                {{#each results}}
                    <option value=`{{this.number}}`>{{this.name}}</option>
                {{/each}} 
            </select>
        </div>
    </div>
    <br><br>
    <h2>How Long Are You Planning on Staying?</h2>
    <div class="length">
        <div class="select">
            <select id="lengthOfStay">
                    <option value = "">Select One</option>
                    <option value = "30">30 min.</option>
                    <option value = "45">45 min.</option>
                    <option value = "1">1 hr.</option>
                    <option value = "2">2 hrs.</option>
                    <option value = "3">3+ hrs.</option>
                </select><br>
        </div>
    </div><br><br>
    
    <button class="button1" id="displayMap">Continue</button><br><br>
    <span id="buttonWasClicked"></span>
    <p id="demo"></p><br><br>
    
    <div class="mapouter">
        <div class="gmap_canvas">
            <p style="text-align: center;">
            <iframe width="695" height="500" id="gmap_canvas" src="https://maps.google.com/maps?q=csumb%20parking%20lot%201%20&t=&z=17&ie=UTF8&iwloc=&output=embed" frameborder="0" scrolling="no" marginheight="0" marginwidth="0">
            </iframe>
            <a href="https://www.bitgeeks.net/divi-discount-elegant-themes-coupon/"></a>
            </div>
            <style>.mapouter{position:relative;text-align:right;height:500px;width:695px;}.gmap_canvas {overflow:hidden;background:none!important;height:500px;width:695px;}</style>
            </div>
    <hr><br>
    <footer>
        CST336: Internet Programming<br> &copy; 2019. Parking Waze<br> Disclaimer: The information in this page might be inaccurate.<br> It is used for academic purposes only.<br><br>
    </footer>
    <script>
            // FOR TIMEPICKER  
            $(document).ready(function() {
                $('input.timepicker').timepicker({});
            });
    
            $('.timepicker').timepicker({
                timeFormat: 'h:mm p',
                interval: 15,
                minTime: '0',
                maxTime: '10:00pm',
                defaultTime: '11',
                startTime: '0:00',
                dynamic: false,
                dropdown: true,
                scrollbar: true
            });
    
            // FUNCTIONS FOR GETTING USER'S LOCATION 
            var x = document.getElementById("demo");
    
            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                } else {
                    x.innerHTML = "Geolocation is not supported by this browser.";
                }
            }
    
            function showPosition(position) {
                x.innerHTML = "Latitude: " + position.coords.latitude +
                    "<br>Longitude: " + position.coords.longitude;
            }
    
            // DISPLAY MAP BUTTON ON CLICK 
            $("#displayMap").on("click", function(e) {
                // CHECK IF USER INPUTED ALL VALUES 
                if($("#timeOfArrival").val() == "" || $("#buildingChoice").val() == "" || $("#lengthOfStay").val() == "") {
                    $("#buttonWasClicked").html("Error, missing selection above").css("color", "red"); 
                } else {
                    $("#buttonWasClicked").html("One second....").css("color", "green"); 
                    getLocation(); 
                    
                    $.ajax({
                        type: "POST",
                        url: "/gmap",
                        dataType: "json",
                        contentType: "application/json",
                        data: JSON.stringify({
                            "building": $("#buildingChoice").val(), 
                        }),
                        success: function(result, status) {
                            if (result.successful) {
                                // window.location.href = '/'; // This will navigate to wherever i say...
                            showMap(result.lots); 
                            }
                            else {
                                // Show an error message or something and stay here
                                $('#message').html("error").css("color", "red");
                                $('#message').show();
                            }
                        },
                        error: function(xhr, status, message) {
                            console.log("error: ", xhr.responseText);
                        }
                    });
                }
            });
            
            function showMap (results) {
            $.ajax({
                        type: "POST",
                        url: "/gmap",
                        dataType: "json",
                        contentType: "application/json",
                        data: JSON.stringify({
                            "building": $("#buildingChoice").val(), 
                        }),
                        success: function(result, status) {
                            if (result.successful) {
                                // window.location.href = '/'; // This will navigate to wherever i say...
                            showMap(result.lots); 
                            }
                            else {
                                // Show an error message or something and stay here
                                $('#message').html("error").css("color", "red");
                                $('#message').show();
                            }
                        },
                        error: function(xhr, status, message) {
                            console.log("error: ", xhr.responseText);
                        }
                    });
            }
           
        </script>
    </body>
</html>
