<!DOCTYPE html>
<html>
    <head>
        <title>Parking Waze</title>
        <link rel="stylesheet" href="/css/styles.css" />
        <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
    </head>
    <body>
        <a class="button fadeIn fourth" href="/" style="color:black;">Back</a>
        <div class="header1">
            <h1>Parking Waze</h1>
        </div>
        
        {{!-- LOCATION OF NEXT CLASS SECTION --}}
        <h2>Location of Next Class:</h2>
        <div class="buildings">
            <div class="select">
                <select id="buildingChoice">
                    <option value="">Select One</option>
                    {{#each results}}
                        <option value={{this.number}}>{{this.buildingname}}</option>
                    {{/each}} 
                </select>
            </div>
        </div><br><br>
        
        {{!-- TIME ARRIVAL SECTION--}}
        {{!--<h2>Time of Arrival on Campus?</h2>--}}
        {{!--<form id="arrival">--}}
        {{!--    <input type="text" class="timepicker" name="time" id="timeOfArrival" />--}}
        {{!--</form><br><br>--}}
        
        {{!-- LENGTH OF STAY SECTION --}}
        {{!--<h2>How Long Are You Planning on Staying?</h2>--}}
        {{!--<div class="length">--}}
        {{!--    <div class="select">--}}
        {{!--        <select id="lengthOfStay">--}}
        {{!--            <option value = "">Select One</option>--}}
        {{!--            <option value = "30">30 min.</option>--}}
        {{!--            <option value = "45">45 min.</option>--}}
        {{!--            <option value = "1">1 hr.</option>--}}
        {{!--            <option value = "2">2 hrs.</option>--}}
        {{!--            <option value = "3">3+ hrs.</option>--}}
        {{!--        </select><br>--}}
        {{!--    </div>--}}
        {{!--</div><br><br>--}}
        
        {{!-- CONTINUE BUTTON --}}
        <button class="button1" id="displayMap">Continue</button><br><br>
        <span id="helloMessage"></span>
        <span id="buttonWasClicked"></span>
        
        {{!-- THIS IS THE MAP --}}
        <div class="mapouter" id="popUpMap" style="display:none;">
            <img width="600" height="300"
            src="https://maps.googleapis.com/maps/api/staticmap?center=CSUMB,+CA&zoom=14&scale=1
            &size=600x300&maptype=roadmap&key=AIzaSyDlV0NWS5Wk-Ds_700VZ4EO8-S_YRJQbNo&format=png&visual_refresh=true" 
            alt="Google Map CSUMB">
        </div>
        
        {{!-- FOOTER --}}
        <hr><br>
        <footer>
            CST336: Internet Programming<br> &copy; 2019. Parking Waze<br> 
            Disclaimer: The information in this page might be inaccurate.<br> 
            It is used for academic purposes only.<br><br>
        </footer>
        <script>
            // FOR TIMEPICKER  
            $(document).ready(function() {
                $('input.timepicker').timepicker({});
            });
    
            $('.timepicker').timepicker({
                timeFormat: 'h:mm p',
                interval: 15,
                minTime: '0',
                maxTime: '10:00pm',
                defaultTime: '11',
                startTime: '0:00',
                dynamic: false,
                dropdown: true,
                scrollbar: true
            });
    
            // DISPLAY MAP BUTTON ON CLICK 
            $("#displayMap").on("click", function(e) {
                // CHECK IF USER INPUTED ALL VALUES 
                let building = $("#buildingChoice").val(); 
                if($("#buildingChoice").val() == "") {
                    $("#buttonWasClicked").html("Error, missing selection above").css("color", "red"); 
                } else {
                    $("#buttonWasClicked").html("One second....<br><br>").css("color", "green"); 
                    
                    // GET THE LOTS NEAR THE BUILDING 
                    $.ajax({
                        type: "POST",
                        url: "/gmap",
                        dataType: "json",
                        contentType: "application/json",
                        data: JSON.stringify({
                            "buildingNumber": $("#buildingChoice").val(), 
                        }),
                        success: function(result, status) {
                            if (result.successful) {
                                // PRINT RESULTS 
                                $("#helloMessage").html(`<h3>Hello ${result.user}, 
                                according to your input, building ${result.results[0].buildingname}, <br>the closest lots to you are 
                                lot ${result.results[0].lot1}, lot ${result.results[0].lot2}, and lot ${result.results[0].lot3}</h3><br><br>`);
                                document.getElementById("popUpMap").style.display = "block";
                                document.getElementById("popUpMap").src = `https://maps.googleapis.com/maps/api/staticmap?center=CSUMB,+CA
                                &zoom=14&scale=1&size=600x300&maptype=roadmap&key=AIzaSyDlV0NWS5Wk-Ds_700VZ4EO8-S_YRJQbNo
                                &format=png&visual_refresh=true
                                &markers=color:blue%7Clabel:S%7C${result.coordinates[0].latitude},${result.coordinates[0].longitude}`;
                            }
                            else {
                                // Show an error message or something and stay here
                                $('#message').html("error").css("color", "red");
                                $('#message').show();
                            }
                        },
                        error: function(xhr, status, message) {
                            console.log("error: ", xhr.responseText);
                        }
                    });
                }
            });
        </script>
    </body>
</html>
